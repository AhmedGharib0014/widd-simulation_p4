@startuml WIDD Component Architecture

!theme plain
skinparam componentStyle rectangle
skinparam backgroundColor #FFFFFF

title WIDD System - Component Architecture\n(P4 Switch with Packet-In/Out)

' ==================== NETWORK TOPOLOGY ====================

package "Mininet-WiFi Network (Simulation)" as Network #LightGreen {
    component [sta1\n00:00:00:00:00:01] as STA1
    component [sta2\n00:00:00:00:00:02] as STA2

    component [ap1\nSSID: WIDD_Network] as AP1

    component [attacker\n00:00:00:00:00:99] as Attacker

    note bottom of Network
        Mininet-WiFi provides the
        network namespace isolation.
        TC mirroring copies traffic
        from AP wireless to switch.
    end note
}

' ==================== DATA PLANE ====================

package "Data Plane (bmv2 P4 Switch)" as DataPlane #LightCyan {
    component [s1 (simple_switch)\nwidd.p4\nThrift: 9090] as P4Switch

    note right of P4Switch
        **P4 Parser:**
        1. Parse Ethernet (ethertype 0x88B5)
        2. Parse wifi_fc_t (2 bytes)
        3. Parse wifi_addr_t (20 bytes)
        4. Parse rf_features_t (8 bytes)

        **Packet-In (to CPU):**
        - Management frames -> CPU port 255
        - Prepends cpu_header_t (4 bytes)

        **Packet-Out (from CPU):**
        - Parse CPU header
        - Forward to dest port
        - Strip CPU header
    end note
}

' ==================== CONTROL PLANE ====================

package "Control Plane (Python)" as ControlPlane #LightBlue {
    component [SwitchInterface\nPacket-In/Out\n(Scapy + raw socket)] as SwitchInterface

    component [OODA Controller\n(start_server.py)] as OODA

    component [MOCC\nRF Fingerprinting] as MOCC

    component [KCSM Manager\nState Machines] as KCSM

    component [Logger] as Logger

    note right of OODA
        **OODA Loop:**
        1. OBSERVE: Receive from SwitchInterface
        2. ORIENT: MOCC RF verification
        3. DECIDE: KCSM state update
        4. ACT: Drop OR forward via Packet-Out
    end note
}

' ==================== ATTACK SIMULATION ====================

package "Attack Simulation" as AttackSim #LightCoral {
    component [attack_generator.py\n(Scapy-based)] as AttackGen

    component [interactive_attack.py\n(CLI Interface)] as AttackCLI

    note right of AttackGen
        **WIDD Frame Format:**
        [Ethernet Header (14 bytes)]
          - dst: AP MAC
          - src: spoofed MAC
          - type: 0x88B5 (WIDD)
        [802.11 FC (2 bytes)]
        [802.11 Addresses (20 bytes)]
        [RF Features (8 bytes)]
        [Payload]

        Simulates what an AP would
        produce after capturing
        real 802.11 frames
    end note
}

' ==================== DEMO LAUNCHER ====================

package "Demo Launcher" as Demo #LightYellow {
    component [demo_launcher.sh\n3 xterm windows] as Launcher

    note right of Launcher
        Launches:
        1. Mininet-WiFi topology
        2. OODA Controller
        3. Attack CLI
    end note
}

' ==================== INTERFACES ====================

' Attack CLI sends through attacker interface
interface "attacker-wlan0\n(wireless)" as AttackerWlan
AttackCLI -down-> AttackGen : uses
AttackGen -down-> AttackerWlan : sendp()\nWIDD frames
AttackerWlan -down-> AP1 : WiFi

' AP mirrors to switch
interface "ap1-eth1 <-> s1-eth1\n(tc mirroring)" as APSwitch
AP1 -down-> APSwitch : mirror
APSwitch -down-> P4Switch : port 1

note right of APSwitch
    **TC Mirroring:**
    Traffic from ap1-wlan is
    mirrored to ap1-eth1 which
    connects to s1-eth1
end note

' CPU Port veth pair
interface "s1-cpu-s <-> s1-cpu-h\n(veth pair, port 255)" as CPUPort
P4Switch -down- CPUPort : Packet-In\nPacket-Out
CPUPort -down- SwitchInterface

note left of CPUPort
    **Bidirectional:**
    Packet-In: P4 -> Controller
    Packet-Out: Controller -> P4
end note

' Control Plane internal connections
SwitchInterface -down-> OODA : PacketInEvent
OODA *-- MOCC
OODA *-- KCSM
OODA ..> Logger : logs events
OODA -up-> SwitchInterface : send_packet_out()

' Demo launcher
Launcher ..> Network : starts
Launcher ..> OODA : starts
Launcher ..> AttackCLI : starts

' ==================== PACKET FLOW ====================

note bottom of DataPlane
    **Packet Flow:**

    1. Attacker sends WIDD frame via attacker-wlan0

    2. AP receives frame, TC mirrors to s1-eth1

    3. P4 parser extracts headers (ethertype 0x88B5)

    4. P4 ingress sends management frames to CPU port

    5. P4 deparser prepends CPU header, emits packet

    6. Packet arrives at s1-cpu-h (controller interface)

    7. SwitchInterface parses and creates PacketInEvent

    8. OODA Controller:
       - MOCC detects RF signature mismatch
       - KCSM updates state machine
       - Decision: DROP or PASS

    9. If PASS: Controller sends Packet-Out
       - Extracts raw 802.11 frame
       - Sends via s1-cpu-h with CPU header
       - P4 forwards to destination port
end note

' ==================== LEGEND ====================

legend right
    |= Color |= Layer |
    | <#LightGreen> | Mininet-WiFi Network |
    | <#LightCyan> | Data Plane (P4/bmv2) |
    | <#LightBlue> | Control Plane (Python) |
    | <#LightCoral> | Attack Simulation |
    | <#LightYellow> | Demo Launcher |
endlegend

@enduml
